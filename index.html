<script>
    window.onload = function() {
      const status = document.getElementById('status');
      const guide = document.getElementById('guide');
      const marker = document.querySelector('#animated-marker');
      const modelUpload = document.getElementById('model-upload');
      const modelInfo = document.getElementById('model-info');
      const modelEntity = document.getElementById('model-entity');

      // ตั้งค่าโมเดลเริ่มต้น (ถ้ามีไฟล์ model.glb อยู่)
      modelEntity.setAttribute('gltf-model', 'model.glb');

      // จัดการการอัพโหลดไฟล์
      modelUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          // ตรวจสอบชนิดไฟล์
          const fileExt = file.name.toLowerCase();
          if (!fileExt.endsWith('.glb') && !fileExt.endsWith('.gltf')) {
            alert('กรุณาเลือกไฟล์ .glb หรือ .gltf เท่านั้น');
            return;
          }

          console.log('เลือกไฟล์:', file.name);
          modelInfo.textContent = `${file.name} (กำลังโหลด...)`;
          
          // สร้าง URL สำหรับไฟล์
          const url = URL.createObjectURL(file);
          console.log('URL ที่สร้าง:', url);
          
          // ลบ attribute เก่าก่อน
          modelEntity.removeAttribute('gltf-model');
          
          // รอสักครู่แล้วตั้งค่าใหม่
          setTimeout(() => {
            modelEntity.setAttribute('gltf-model', url);
            console.log('ตั้งค่าโมเดลแล้ว');
          }, 200);
        }
      });

      // ฟังก์ชันเมื่อโมเดลโหลดสำเร็จ
      modelEntity.addEventListener('model-loaded', function(e) {
        console.log('โมเดลโหลดสำเร็จแล้ว!');
        const currentText = modelInfo.textContent;
        if (currentText.includes('กำลังโหลด')) {
          modelInfo.textContent = currentText.replace('(กำลังโหลด...)', '✓ พร้อมใช้งาน');
        }
      });

      // ฟังก์ชันเมื่อเกิดข้อผิดพลาด
      modelEntity.addEventListener('model-error', function(e) {
        console.error('เกิดข้อผิดพลาดในการโหลดโมเดล:', e);
        modelInfo.textContent = 'ข้อผิดพลาด: ไม่สามารถโหลดโมเดลได้';
      });

      // เพิ่มการ Debug
      marker.addEventListener('markerFound', function() {
        console.log('พบมาร์คเกอร์แล้ว');
        guide.parentElement.style.display = 'none';
        status.textContent = 'พบมาร์คเกอร์แล้ว!';
        status.parentElement.style.background = 'rgba(0, 255, 0, 0.7)';
        
        // ตรวจสอบว่าโมเดลมีอยู่หรือไม่
        const hasModel = modelEntity.getAttribute('gltf-model');
        console.log('โมเดลปัจจุบัน:', hasModel);
      });

      marker.addEventListener('markerLost', function() {
        console.log('มาร์คเกอร์หายไป');
        guide.parentElement.style.display = 'flex';
        status.textContent = 'กำลังค้นหามาร์คเกอร์...';
        status.parentElement.style.background = 'rgba(0, 0, 0, 0.7)';
      });

      // เพิ่มปุ่มทดสอบโมเดล
      const testBtn = document.createElement('button');
      testBtn.textContent = 'ทดสอบโมเดล';
      testBtn.style.cssText = `
        position: fixed;
        top: 160px;
        left: 50%;
        transform: translateX(-50%);
        background: #ff4444;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 10px;
        cursor: pointer;
        z-index: 1001;
      `;
      testBtn.onclick = function() {
        const currentModel = modelEntity.getAttribute('gltf-model');
        console.log('โมเดลปัจจุบัน:', currentModel);
        console.log('Element:', modelEntity);
        alert(`โมเดลปัจจุบัน: ${currentModel || 'ไม่มี'}`);
      };
      document.body.appendChild(testBtn);
    };
</script>